---
import { getCollection } from 'astro:content';
import BaseLayout from '@/layouts/BaseLayout.astro';
import TimelineItem from '@/components/TimelineItem.astro';
import { getTranslations, type Language } from '@/i18n/translations';

const { lang } = Astro.params as { lang: Language };

if (!['es', 'en'].includes(lang)) {
  return Astro.redirect('/es/blog');
}

const t = getTranslations(lang).blog;

type BlogPostData = {
  language: string;
  pubDate: Date;
  title: string;
  description: string;
};

type BlogPost = {
  slug: string;
  data: BlogPostData;
};

const allPosts: BlogPost[] = await getCollection('blog', ({ data }: { data: BlogPostData }) => {
  return data.language === lang;
});

const sortedPosts: BlogPost[] = allPosts.sort(
  (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime()
);

function formatDate(date: Date, locale: string): string {
  return new Intl.DateTimeFormat(locale, {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}
---

<BaseLayout 
  title={t.title} 
  description={t.description}
  lang={lang}
>
  <div class="max-w-4xl">
    <h1 class="text-5xl md:text-6xl font-serif font-bold mb-16">{t.heading}</h1>
    
    <div class="timeline">
      {sortedPosts.map((post: BlogPost, index: number) => {
        const slug = post.slug.replace(`${post.data.language}/`, '');
        const isHighlighted = index % 3 === 0;
        return (
          <TimelineItem
            title={post.data.title}
            date={formatDate(post.data.pubDate, lang)}
            description={post.data.description}
            href={`/${lang}/blog/${slug}`}
            isHighlighted={isHighlighted}
          />
        );
      })}
    </div>
  </div>
</BaseLayout>

<style>
  .timeline {
    position: relative;
    padding-left: 3rem;
    margin-left: 1rem;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 2px;
    background-color: var(--timeline-line);
  }
</style>
