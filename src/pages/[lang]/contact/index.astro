---
import BaseLayout from '@/layouts/BaseLayout.astro';
import ContactForm from '@/components/ContactForm.astro';
import Reveal from '@/components/Reveal';
import { getTranslations, type Language } from '@/i18n/translations';

const { lang } = Astro.params as { lang: Language };

// Validate lang parameter in SSR mode
if (!['es', 'en'].includes(lang)) {
  return Astro.redirect('/es/contact');
}

const t = getTranslations(lang);
---

<BaseLayout 
  title={t.contact.title} 
  description={t.contact.description}
  lang={lang}
>
  <div class="max-w-4xl">
    <Reveal client:load>
      <h1 class="text-5xl md:text-6xl page-title mt-10" style="text-transform: lowercase;">{t.contact.heading}</h1>
    </Reveal>
    
    <!-- Request CV Section -->

      <section class="contact-section">
        <h2 class="section-title">{t.contact.requestCvTitle}</h2>
        <p class="section-description">{t.contact.requestCvDescription}</p>
        <ContactForm lang={lang} />
      </section>

  </div>
  
  <!-- Language Switcher Hint Animation -->
  <div id="language-hint-container" class="language-hint-container" data-lang={lang}>
    <!-- Desktop: Arrow from bottom left pointing to top right language switcher -->
    <div class="language-hint-desktop">
      <div class="language-hint-popup-desktop">
        <p class="language-hint-message">{t.languageHint.message}</p>
      </div>
      <div class="language-hint-arrow-desktop">
        <svg width="50" height="50" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M78.1,0v6.2c22.4,0,40.5,18.2,40.5,40.6s-18.1,40.6-40.5,40.6H17.9l27.9-28l-4.5-4.5L5.5,90.8l0,0l0,0L41.5,127l4.5-4.5L17.2,93.6h60.9c25.8,0,46.7-21,46.7-46.8S103.9,0,78.1,0z" fill="var(--color-accent)"/>
        </svg>
      </div>
    </div>
    
    <!-- Mobile: Arrow pointing from bottom to language switcher -->
    <div class="language-hint-mobile">
      <div class="language-hint-arrow-mobile">
        <svg width="32" height="32" viewBox="0 0 128 128" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M78.1,0v6.2c22.4,0,40.5,18.2,40.5,40.6s-18.1,40.6-40.5,40.6H17.9l27.9-28l-4.5-4.5L5.5,90.8l0,0l0,0L41.5,127l4.5-4.5L17.2,93.6h60.9c25.8,0,46.7-21,46.7-46.8S103.9,0,78.1,0z" fill="var(--color-accent)"/>
        </svg>
      </div>
      <div class="language-hint-popup-mobile">
        <p class="language-hint-message">{t.languageHint.message}</p>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .page-title {
    font-family: var(--font-family-sans);
    font-size: 3rem;
    font-weight: 700;
    margin-bottom: 3rem;
    line-height: 1.2;
  }

  .contact-section {
    margin-bottom: 4rem;
    animation: slideUpFromBottom 0.8s ease-out 0.2s both;
  }
  
  @keyframes slideUpFromBottom {
    from {
      opacity: 0;
      transform: translateY(50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .section-title {
    font-family: var(--font-family-sans);
    font-size: 1.5rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 3px solid var(--color-text);
  }

  .section-description {
    font-size: 1.125rem;
    line-height: 1.6;
    margin-bottom: 2rem;
    color: var(--color-text);
    opacity: 0.9;
  }

  .contact-info {
    border: 3px solid var(--color-text);
    padding: 2rem;
    background-color: var(--timeline-item-bg);
  }

  .info-item {
    margin-bottom: 1rem;
    font-size: 1.125rem;
  }

  .info-item:last-child {
    margin-bottom: 0;
  }

  .info-label {
    font-family: var(--font-family-sans);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: 0.875rem;
  }

  .info-link {
    color: var(--color-text);
    text-decoration: underline;
    text-underline-offset: 4px;
    transition: all 0.2s ease;
  }

  .info-link:hover {
    text-decoration-thickness: 2px;
  }

  .info-value {
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .page-title {
      font-size: 2rem;
    }

    .section-title {
      font-size: 1.25rem;
    }

    .section-description {
      font-size: 1rem;
    }

    .contact-info,
    .contact-form {
      padding: 1.5rem;
    }
  }
  
  /* Language Switcher Hint Animation */
  .language-hint-container {
    position: fixed;
    z-index: 1001;
    pointer-events: none;
    display: block !important;
  }
  
  .language-hint-message {
    margin: 0;
    font-size: 0.875rem;
    line-height: 1.4;
    color: var(--color-text);
    font-weight: 500;
  }
  
  /* Desktop Animation - Arrow from bottom left pointing to top right language switcher */
  .language-hint-desktop {
    display: none;
  }
  
  @media (min-width: 768px) {
    .language-hint-desktop {
      display: block !important;
      position: fixed;
      bottom: 2rem;
      left: calc(4rem + 2rem);
      width: 300px;
      height: 125px;
      padding: 0;
      background: radial-gradient(ellipse 120% 120% at center, rgba(0, 0, 0, 0.25) 0%, rgba(0, 0, 0, 0.15) 40%, transparent 80%);
      border-radius: 0.5rem;
      transition: filter 0.3s ease, opacity 0.3s ease;
      opacity: 0;
      animation: containerRevealDesktop 0.8s ease-out 0.8s forwards;
      overflow: visible;
      backdrop-filter: blur(2px);
    }
    
    .language-hint-arrow-desktop {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 45px;
      height: 45px;
      opacity: 0;
      animation: arrowRevealDesktop 1s ease-out 1s forwards;
      overflow: visible;
      transform: rotate(135deg); /* Rotate to point from bottom-left to top-right */
    }
    
    .language-hint-arrow-desktop svg {
      width: 100%;
      height: 100%;
    }
    
    .language-hint-popup-desktop {
      position: absolute;
      top: 50%;
      left: 57%;
      transform: translate(-50%, -50%) translateY(10px);
      background-color: var(--color-bg);
      border: 2px solid var(--color-accent);
      border-radius: 0.75rem;
      padding: 1rem 1.5rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      opacity: 0;
      animation: popupRevealDesktop 0.6s ease-out 1.5s forwards,
                 popupShake 3.8s ease-in-out 2.1s infinite;
      max-width: 220px;
      width: max-content;
      z-index: 1;
      transition: filter 0.3s ease, opacity 0.3s ease;
      white-space: normal;
      word-wrap: break-word;
    }
    
    .language-hint-arrow-desktop {
      transition: filter 0.3s ease;
    }
    
    [data-theme="dark"] .language-hint-popup-desktop {
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 255, 136, 0.3);
    }
  }
  
  /* Mobile Animation - Arrow at top right pointing to language switcher */
  .language-hint-mobile {
    display: block !important;
    position: fixed;
    top: 1.5rem;
    right: 1rem;
    width: 150px;
  }
  
  @media (min-width: 768px) {
    .language-hint-mobile {
      display: none !important;
    }
  }
  
  .language-hint-arrow-mobile {
    display: none; /* Arrow removed for mobile */
  }
  
  .language-hint-arrow-mobile svg {
    width: 100%;
    height: 100%;
  }
  
  .language-hint-popup-mobile {
    position: absolute;
    right: 0;
    top: 2.5rem;
    background-color: var(--color-bg);
    border: 2px solid var(--color-accent);
    border-radius: 0.75rem;
    padding: 0.875rem 1rem;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    opacity: 0;
    transform: translateY(-10px);
      animation: popupRevealMobile 0.6s ease-out 1.5s forwards,
                 popupShake 2.5s ease-in-out 2.1s infinite;
    max-width: 150px;
  }
  
  [data-theme="dark"] .language-hint-popup-mobile {
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5), 0 0 20px rgba(0, 255, 136, 0.3);
  }
  
  @keyframes arrowRevealDesktop {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  @keyframes popupRevealDesktop {
    from {
      opacity: 0;
      transform: translate(-50%, -50%) translateY(10px);
    }
    to {
      opacity: 1;
      transform: translate(-50%, -50%) translateY(0);
    }
  }
  
  @keyframes arrowRevealMobile {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes popupRevealMobile {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes popupShake {
    0%, 20%, 100% {
      transform: translate(-50%, -50%) translateY(0) translateX(0);
    }
    2%, 6%, 10%, 14%, 18% {
      transform: translate(-50%, -50%) translateY(0) translateX(-3px);
    }
    4%, 8%, 12%, 16% {
      transform: translate(-50%, -50%) translateY(0) translateX(3px);
    }
  }
  
  @keyframes containerRevealDesktop {
    from {
      opacity: 0;
      transform: scale(0.95) translateY(10px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }
</style>

<script>
  // Hide language hint after user interacts with language switcher or after timeout
  (function() {
    const hintContainer = document.getElementById('language-hint-container');
    if (!hintContainer) {
      console.warn('Language hint container not found');
      return;
    }
    
    console.log('Language hint container found', hintContainer);
    
    const langSwitcher = document.querySelector('.lang-switcher');
    const dismissed = sessionStorage.getItem('language-hint-dismissed');
    const hintDesktop = hintContainer.querySelector('.language-hint-desktop');
    
    console.log('Language hint dismissed check', { dismissed, langSwitcher: !!langSwitcher });
    
    // In dev mode, allow clearing dismissal status via URL parameter
    if (import.meta.env.DEV && new URLSearchParams(window.location.search).get('clear-hint') === 'true') {
      sessionStorage.removeItem('language-hint-dismissed');
      console.log('Language hint dismissal cleared via URL parameter');
    }
    
    // Don't show if already dismissed in this session
    if (sessionStorage.getItem('language-hint-dismissed') === 'true') {
      console.log('Language hint already dismissed, hiding');
      hintContainer.style.display = 'none';
      return;
    }
    
    console.log('Language hint will be shown');
    
    // Fade out hint when submit button is hovered
    const popupDesktop = hintContainer.querySelector('.language-hint-popup-desktop');
    
    // Set up hover effects - try multiple times to catch the button when it loads
    const setupHoverEffects = () => {
      const submitBtn = document.getElementById('submit-btn');
      if (submitBtn && hintDesktop && hintDesktop instanceof HTMLElement) {
        submitBtn.addEventListener('mouseenter', () => {
          console.log('Submit button hovered');
          hintDesktop.style.filter = 'blur(8px)';
          hintDesktop.style.opacity = '0.5';
          if (popupDesktop && popupDesktop instanceof HTMLElement) {
            popupDesktop.style.opacity = '0';
          }
        });
        
        submitBtn.addEventListener('mouseleave', () => {
          console.log('Submit button unhovered');
          hintDesktop.style.filter = 'none';
          hintDesktop.style.opacity = '1';
          if (popupDesktop && popupDesktop instanceof HTMLElement) {
            popupDesktop.style.opacity = '1';
          }
        });
        
        console.log('Hover effects set up successfully');
        return true;
      }
      return false;
    };
    
    // Try immediately
    if (!setupHoverEffects()) {
      // Retry after delays
      setTimeout(setupHoverEffects, 300);
      setTimeout(setupHoverEffects, 1000);
      
      // Also listen for Astro page load events
      document.addEventListener('astro:page-load', () => {
        setTimeout(setupHoverEffects, 100);
      });
    }
    
    // Hide on language switcher click
    langSwitcher?.addEventListener('click', () => {
      console.log('Language switcher clicked, hiding hint');
      hintContainer.style.opacity = '0';
      hintContainer.style.transition = 'opacity 0.3s ease';
      setTimeout(() => {
        hintContainer.style.display = 'none';
      }, 300);
      sessionStorage.setItem('language-hint-dismissed', 'true');
    });
    
    // Auto-hide after 8 seconds
    setTimeout(() => {
      if (hintContainer.style.display !== 'none') {
        console.log('Auto-hiding language hint after 8 seconds');
        hintContainer.style.opacity = '0';
        hintContainer.style.transition = 'opacity 0.3s ease';
        setTimeout(() => {
          hintContainer.style.display = 'none';
        }, 300);
        sessionStorage.setItem('language-hint-dismissed', 'true');
      }
    }, 8000);
  })();
</script>
