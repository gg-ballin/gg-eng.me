---
import type { ExperienceEntry } from '@/lib/experience-data';
import SkillIconLink from './SkillIconLink.astro';
import { getSkillIconConfig } from '@/lib/experience-data';
import { getEmployerLogo } from '@/lib/experience/employers';

interface Props {
  entry: ExperienceEntry;
}

const { entry } = Astro.props;
const employerLogo = getEmployerLogo(entry.company);
const isHighlighted = entry.highlight === true;
---

<article class="experience-entry">
  <div class="experience-date">{entry.dateRange}</div>
  <div class={`experience-content ${isHighlighted ? 'experience-content-highlighted' : ''}`}>
    {isHighlighted && (
      <div class="highlight-badge">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" fill="currentColor" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/>
        </svg>
      </div>
    )}
    {isHighlighted && (
      <div class="border-trail"></div>
    )}
    <h3 class="experience-role">{entry.role}</h3>
    <div class="experience-company-wrapper">
      {employerLogo && (
        <div class="employer-logo-container">
          {employerLogo.href ? (
            <a href={employerLogo.href} target="_blank" rel="noopener noreferrer" class="employer-logo-link">
              {employerLogo.iconDark && !employerLogo.isPng ? (
                <>
                  <img 
                    src={employerLogo.iconLight} 
                    alt={employerLogo.name} 
                    class="employer-logo employer-logo-light" 
                    width={employerLogo.width || 100}
                    height="auto"
                  />
                  <img 
                    src={employerLogo.iconDark} 
                    alt={employerLogo.name} 
                    class="employer-logo employer-logo-dark" 
                    width={employerLogo.width || 100}
                    height="auto"
                  />
                </>
              ) : (
                <img 
                  src={employerLogo.iconLight} 
                  alt={employerLogo.name} 
                  class="employer-logo" 
                  width={employerLogo.width || 100}
                  height="auto"
                />
              )}
            </a>
          ) : (
            <>
              {employerLogo.iconDark && !employerLogo.isPng ? (
                <>
                  <img 
                    src={employerLogo.iconLight} 
                    alt={employerLogo.name} 
                    class="employer-logo employer-logo-light" 
                    width={employerLogo.width || 100}
                    height="auto"
                  />
                  <img 
                    src={employerLogo.iconDark} 
                    alt={employerLogo.name} 
                    class="employer-logo employer-logo-dark" 
                    width={employerLogo.width || 100}
                    height="auto"
                  />
                </>
              ) : (
                <img 
                  src={employerLogo.iconLight} 
                  alt={employerLogo.name} 
                  class="employer-logo" 
                  width={employerLogo.width || 100}
                  height="auto"
                />
              )}
            </>
          )}
        </div>
      )}
      <p class="experience-company">{entry.company}</p>
    </div>
    <p class="experience-description">{entry.description}</p>
    
    {entry.skills && entry.skills.length > 0 && (
      <div class="experience-skills">
        {entry.skills.map((skill) => {
          const iconConfig = getSkillIconConfig(skill);
          if (iconConfig) {
            return <SkillIconLink iconConfig={iconConfig} />;
          }
          // Fallback to text badge if no icon found
          return <span class="skill-tag">{skill}</span>;
        })}
      </div>
    )}
    
    {entry.projects && entry.projects.length > 0 && (
      <div class="experience-projects">
        <h4 class="projects-title">PROJECT DEEP DIVES</h4>
        {entry.projects.map((project) => (
          <div class="project-item">
            <h5 class="project-name">{project.name}</h5>
            <ul class="project-achievements">
              {project.achievements.map((achievement) => (
                <li>{achievement}</li>
              ))}
            </ul>
          </div>
        ))}
      </div>
    )}
  </div>
</article>

<style>
  .experience-entry {
    margin-bottom: 4rem;
    position: relative;
    padding-left: 2rem;
  }
  
  .experience-entry:last-child {
    margin-bottom: 0;
  }
  
  .experience-date {
    font-family: var(--font-family-sans);
    font-size: 0.875rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    margin-bottom: 1rem;
    color: var(--color-accent);
    opacity: 0.8;
  }
  
  .experience-content {
    border: 3px solid var(--color-text);
    padding: 1.5rem;
    background-color: var(--timeline-item-bg);
    transition: all 0.2s ease;
    position: relative;
  }
  
  .experience-content:hover {
    transform: translate(4px, -4px);
    box-shadow: -4px 4px 0 var(--color-accent);
  }
  
  /* Override hover for highlighted entries - no accent line */
  .experience-content-highlighted:hover {
    transform: translate(4px, -4px);
    box-shadow: 
      0 0 20px rgba(99, 102, 241, 0.3),
      0 0 40px rgba(99, 102, 241, 0.2);
  }
  
  [data-theme="dark"] .experience-content-highlighted:hover {
    box-shadow: 
      0 0 20px rgba(0, 255, 136, 0.4),
      0 0 40px rgba(0, 255, 136, 0.3);
  }
  
  /* Highlight badge */
  .highlight-badge {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10;
    color: var(--color-accent);
    animation: starPulse 2s ease-in-out infinite;
    filter: drop-shadow(0 0 4px currentColor);
  }
  
  @keyframes starPulse {
    0%, 100% {
      transform: scale(1) rotate(0deg);
      opacity: 1;
    }
    50% {
      transform: scale(1.1) rotate(180deg);
      opacity: 0.9;
    }
  }
  
  /* Neon border trail animation */
  .experience-content-highlighted {
    border: 3px solid var(--color-text);
    position: relative;
    background: var(--timeline-item-bg);
  }
  
  .border-trail {
    position: absolute;
    width: 80px;
    height: 3px;
    background: linear-gradient(90deg, transparent, var(--color-accent), transparent);
    box-shadow: 0 0 10px var(--color-accent), 0 0 20px var(--color-accent);
    z-index: -1;
    opacity: 0;
    pointer-events: none;
    /* animation: borderTrailMove 3s linear infinite; */
    transform-origin: center center;
    display: none; /* Hidden until animation is enabled */
  }
  
  /* Border trail animation - commented out for future feature
  @keyframes borderTrailMove {
    Top edge - horizontal, moving right
    0% {
      top: -3px;
      left: 0%;
      width: 80px;
      height: 3px;
      transform: translateX(0) rotate(0deg);
    }
    24% {
      top: -3px;
      left: 100%;
      width: 80px;
      height: 3px;
      transform: translateX(-100%) rotate(0deg);
    }
    Right edge - vertical, moving down
    26% {
      top: 0%;
      left: 100%;
      width: 3px;
      height: 80px;
      transform: translateX(-100%) translateY(0) rotate(90deg);
    }
    49% {
      top: 100%;
      left: 100%;
      width: 3px;
      height: 80px;
      transform: translateX(-100%) translateY(-100%) rotate(90deg);
    }
    Bottom edge - horizontal, moving left
    51% {
      top: 100%;
      left: 100%;
      width: 80px;
      height: 3px;
      transform: translateX(-100%) translateY(-100%) rotate(180deg);
    }
    74% {
      top: 100%;
      left: 0%;
      width: 80px;
      height: 3px;
      transform: translateX(0) translateY(-100%) rotate(180deg);
    }
    Left edge - vertical, moving up
    76% {
      top: 100%;
      left: -3px;
      width: 3px;
      height: 80px;
      transform: translateX(0) translateY(-100%) rotate(270deg);
    }
    99% {
      top: 0%;
      left: -3px;
      width: 3px;
      height: 80px;
      transform: translateX(0) translateY(0) rotate(270deg);
    }
    100% {
      top: -3px;
      left: 0%;
      width: 80px;
      height: 3px;
      transform: translateX(0) rotate(0deg);
    }
  }
  */
  
  .experience-role {
    font-family: var(--font-family-serif);
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.2;
    margin-bottom: 0.5rem;
  }
  
  .experience-company-wrapper {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }
  
  .employer-logo-container {
    display: flex;
    align-items: center;
  }
  
  .employer-logo-link {
    display: inline-block;
    transition: opacity 0.2s ease;
  }
  
  .employer-logo-link:hover {
    opacity: 0.8;
  }
  
  .employer-logo {
    display: inline-block;
    max-width: 100%;
    height: auto;
    object-fit: contain;
  }
  
  .employer-logo-light {
    display: inline-block;
  }
  
  .employer-logo-dark {
    display: none;
  }
  
  .experience-company {
    font-family: var(--font-family-sans);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    opacity: 0.8;
    margin: 0;
  }
  
  .experience-description {
    font-size: 1rem;
    line-height: 1.6;
    margin-bottom: 1.5rem;
    opacity: 0.9;
  }
  
  .experience-skills {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2rem;
  }
  
  .skill-tag {
    font-family: var(--font-family-sans);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.375rem 0.75rem;
    border: 2px solid var(--color-text);
    background-color: var(--color-bg);
    color: var(--color-text);
  }
  
  .experience-projects {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 2px solid var(--color-border);
  }
  
  .projects-title {
    font-family: var(--font-family-sans);
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 1.5rem;
  }
  
  .project-item {
    margin-bottom: 2rem;
  }
  
  .project-item:last-child {
    margin-bottom: 0;
  }
  
  .project-name {
    font-family: var(--font-family-sans);
    font-size: 1rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    position: relative;
    padding-left: 1rem;
  }
  
  .project-name::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: var(--color-accent);
  }
  
  .project-achievements {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  
  .project-achievements li {
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-bottom: 0.5rem;
    padding-left: 1.5rem;
    position: relative;
    opacity: 0.9;
  }
  
  .project-achievements li::before {
    content: 'â€¢';
    position: absolute;
    left: 0;
    color: var(--color-accent);
    font-weight: bold;
  }
  
  .project-achievements li:last-child {
    margin-bottom: 0;
  }
  
  @media (max-width: 768px) {
    .experience-entry {
      padding-left: 1.5rem;
      margin-bottom: 3rem;
    }
    
    .experience-content {
      padding: 1.25rem;
    }
    
    .highlight-badge {
      top: 0.75rem;
      right: 0.75rem;
      width: 20px;
      height: 20px;
    }
    
    .highlight-badge svg {
      width: 20px;
      height: 20px;
    }
    
    .experience-role {
      font-size: 1.25rem;
    }
    
    .employer-logo {
      max-width: 120px;
    }
  }
</style>

<style is:global>
  /* Global theme-based employer logo visibility */
  [data-theme="dark"] .employer-logo-light {
    display: none !important;
  }
  
  [data-theme="dark"] .employer-logo-dark {
    display: inline-block !important;
  }
  
  [data-theme="light"] .employer-logo-light,
  :root:not([data-theme="dark"]) .employer-logo-light {
    display: inline-block !important;
  }
  
  [data-theme="light"] .employer-logo-dark,
  :root:not([data-theme="dark"]) .employer-logo-dark {
    display: none !important;
  }
</style>
